# Руководство по обновлению PersonaID

## Обзор изменений

Этот PR обновляет зависимости и исправляет проблемы с захватом камеры.

## Основные изменения

### 1. Обновление зависимостей

Все зависимости были обновлены до последних совместимых версий:

| Пакет | Старая версия | Новая версия |
|-------|---------------|--------------|
| mediapipe | 0.10.11 | 0.10.21 |
| protobuf | 3.20.3 | 4.25.8 |
| opencv-python | 4.9.0.80 | 4.12.0.88 |
| opencv-contrib-python | 4.9.0.80 | 4.12.0.88 |
| Flask | 3.0.2 | 3.1.0 |
| Flask-Cors | 4.0.0 | 5.0.0 |
| psycopg2 | 2.9.9 | 2.9.10 (binary) |
| numpy | 1.26.4 | 1.26.4 (без изменений) |

### 2. Исправление проблемы с захватом камеры

**Проблема:** Камера захватывалась только через OBS.

**Решение:**
- Добавлена поддержка нескольких бэкендов камеры (DirectShow, Media Foundation)
- DirectShow используется первым для совместимости с Windows/OBS
- Автоматический перебор доступных камер (индексы 0, 1, 2)
- Улучшенная обработка ошибок и проверка работоспособности камеры

### 3. Новый файл конфигурации камеры

Создан файл `camera_config.py` для простой настройки параметров камеры:

```python
# Индекс камеры (0 = первая камера, 1 = вторая и т.д.)
CAMERA_INDEX = 0

# Предпочитаемое разрешение
CAMERA_WIDTH = 10000
CAMERA_HEIGHT = 10000

# Подробное логирование
VERBOSE_LOGGING = True
```

## Инструкция по обновлению

### Шаг 1: Обновление зависимостей

#### Linux:
```bash
python3 -m pip install --upgrade -r requirements.txt
```

#### Windows:
```bash
python -m pip install --upgrade -r requirements.txt
```

### Шаг 2: Проверка камеры

Используйте тестовый скрипт для проверки доступности камеры:

```bash
python util/test_cam.py
```

Скрипт автоматически:
- Попробует разные бэкенды (DirectShow, Media Foundation)
- Переберет доступные камеры (индексы 0, 1, 2)
- Покажет видео с рабочей камеры
- Выведет информацию о найденной камере

### Шаг 3: Настройка камеры (опционально)

Если нужна конкретная камера, отредактируйте `camera_config.py`:

```python
# Используйте конкретный индекс камеры
CAMERA_INDEX = 1  # Вторая камера

# Или установите -1 для автоопределения
CAMERA_INDEX = -1
```

### Шаг 4: Запуск системы

Запустите систему как обычно:

```bash
python start_capture.py
```

## Устранение неполадок

### Камера не обнаружена

1. **Проверьте подключение камеры:**
   - Убедитесь, что камера подключена
   - Проверьте, что камера не используется другим приложением

2. **Попробуйте разные индексы:**
   ```python
   # В camera_config.py
   CAMERA_INDEX = 1  # или 2, 3...
   ```

3. **Проверьте права доступа (Linux):**
   ```bash
   sudo usermod -a -G video $USER
   # Перезайдите в систему
   ```

### Конфликты зависимостей

Если возникают конфликты при установке:

1. **Создайте виртуальное окружение:**
   ```bash
   python3 -m venv venv
   source venv/bin/activate  # Linux
   # или
   venv\Scripts\activate  # Windows
   ```

2. **Установите зависимости заново:**
   ```bash
   pip install -r requirements.txt
   ```

### Ошибки совместимости

Система протестирована с Python 3.12. Если используете другую версию:

```bash
python --version  # Проверьте версию
```

Рекомендуется Python 3.10 - 3.12.

## Изменения в коде

### capture_streamer.py

Добавлена функция `init_camera()` с улучшенной инициализацией камеры:

```python
# Старый код:
cap = cv2.VideoCapture(1)  # Жёстко заданный индекс

# Новый код:
cap, width, height = init_camera(
    camera_index=CAMERA_INDEX,
    width=CAMERA_WIDTH,
    height=CAMERA_HEIGHT,
    verbose=VERBOSE_LOGGING
)
```

### util/test_cam.py

Обновлён для использования той же логики инициализации камеры.

## Преимущества обновления

1. ✅ Камера работает без OBS
2. ✅ Лучшая совместимость с Windows
3. ✅ Автоматический поиск доступных камер
4. ✅ Актуальные зависимости без конфликтов
5. ✅ Совместимость с Python 3.12
6. ✅ Нет уязвимостей безопасности
7. ✅ Улучшенная обработка ошибок

## Обратная совместимость

Все изменения обратно совместимы. Существующая функциональность сохранена.

## Поддержка

При возникновении проблем:
1. Проверьте консольный вывод на предмет ошибок
2. Попробуйте `util/test_cam.py` для диагностики
3. Проверьте конфигурацию в `camera_config.py`
4. Убедитесь, что все зависимости установлены корректно

## Безопасность

Все обновлённые зависимости проверены на известные уязвимости.
Код прошёл проверку CodeQL - уязвимостей не обнаружено.
